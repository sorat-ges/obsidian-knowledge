# OrderFee - à¸—à¸µà¹ˆà¸¡à¸²à¹à¸¥à¸°à¸à¸²à¸£à¸„à¸³à¸™à¸§à¸“à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”

## à¸ à¸²à¸à¸£à¸§à¸¡

OrderFee à¸„à¸·à¸­à¸„à¹ˆà¸²à¸˜à¸£à¸£à¸¡à¹€à¸™à¸µà¸¢à¸¡à¸—à¸µà¹ˆà¸„à¸³à¸™à¸§à¸“à¸ˆà¸²à¸ **Fee Rate** à¸—à¸µà¹ˆà¸”à¸¶à¸‡à¸¡à¸²à¸ˆà¸²à¸ Database à¸„à¸¹à¸“à¸à¸±à¸šà¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™à¸—à¸µà¹ˆà¹à¸¥à¸à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™

à¸¡à¸µ 2 Flow à¸«à¸¥à¸±à¸à¹ƒà¸™à¸à¸²à¸£à¸„à¸³à¸™à¸§à¸“ OrderFee:
1. **GetSwapRoutes Flow** - à¸•à¸­à¸™à¸ªà¸£à¹‰à¸²à¸‡ Order à¹à¸¥à¸°à¹à¸ªà¸”à¸‡à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¹ƒà¸«à¹‰à¹€à¸¥à¸·à¸­à¸
2. **OrderTradeWebhook Flow** - à¸•à¸­à¸™ Order à¸–à¸¹à¸ Match à¹à¸¥à¹‰à¸§

---

# à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆ 1: à¸—à¸µà¹ˆà¸¡à¸²à¸‚à¸­à¸‡ Fee Rate

## 1.1 Database Table: transaction_fee

OrderFee à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™à¸ˆà¸²à¸à¸à¸²à¸£à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ Fee Rate à¸ˆà¸²à¸ Database:

**Repository:** `transactionFeeRepository.GetTransactionFeeTx()`

```sql
-- Query à¸—à¸µà¹ˆà¹ƒà¸Šà¹‰à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
SELECT *
FROM transaction_fee
WHERE company_code = 'XD'
  AND transaction_type = 'swap'
  AND fee_type IN ('FEE', 'ADDITIONAL_FEE')
  AND is_deleted = false
  AND start_date <= NOW()
  AND (end_date IS NULL OR end_date >= NOW())
ORDER BY priority ASC;
```

## 1.2 à¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡ transaction_fee

| Column | Type | Description |
|--------|------|-------------|
| `id` | string | Primary Key |
| `company_code` | string | à¸£à¸«à¸±à¸ªà¸šà¸£à¸´à¸©à¸±à¸— (à¹€à¸Šà¹ˆà¸™ 'XD') |
| `transaction_type` | string | à¸›à¸£à¸°à¹€à¸ à¸—à¸˜à¸¸à¸£à¸à¸£à¸£à¸¡ (à¹€à¸Šà¹ˆà¸™ 'swap') |
| `fee_type` | string | 'FEE' à¸«à¸£à¸·à¸­ 'ADDITIONAL_FEE' |
| `priority` | int | à¸¥à¸³à¸”à¸±à¸šà¸„à¸§à¸²à¸¡à¸ªà¸³à¸„à¸±à¸ (à¸™à¹‰à¸­à¸¢ = à¸ªà¸³à¸„à¸±à¸) |
| `condition` | JSON | à¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚à¸à¸²à¸£à¹ƒà¸Šà¹‰ Fee |
| `fee_value` | decimal | à¸„à¹ˆà¸² Fee à¹€à¸Šà¹ˆà¸™ 0.15 (à¹à¸›à¸¥à¸§à¹ˆà¸² 0.15%) |
| `fee_unit` | string | à¸«à¸™à¹ˆà¸§à¸¢à¸‚à¸­à¸‡ Fee (à¹€à¸Šà¹ˆà¸™ 'percent') |
| `start_date` | timestamp | à¸§à¸±à¸™à¸—à¸µà¹ˆà¹€à¸£à¸´à¹ˆà¸¡à¹ƒà¸Šà¹‰ |
| `end_date` | timestamp | à¸§à¸±à¸™à¸—à¸µà¹ˆà¸ªà¸´à¹‰à¸™à¸ªà¸¸à¸” |
| `name` | string | à¸Šà¸·à¹ˆà¸­ Fee |
| `is_include_additional_fee` | boolean | à¸£à¸§à¸¡ Additional Fee à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ |
| `is_campaign` | boolean | à¹€à¸›à¹‡à¸™à¹‚à¸›à¸£à¹‚à¸¡à¸Šà¸±à¹ˆà¸™à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ |

## 1.3 Condition Structure

```json
{
  "condition": [
    {
      "param_name": "customer_tier",
      "operator": "equal",
      "value": "1"
    },
    {
      "param_name": "route",
      "operator": "equal",
      "value": "Bitkub"
    },
    {
      "param_name": "onboarding_day",
      "operator": "less_than_equal",
      "value": "7"
    }
  ]
}
```

### à¸›à¸£à¸°à¹€à¸ à¸— Condition à¸—à¸µà¹ˆà¸£à¸­à¸‡à¸£à¸±à¸š

| param_name        | operator        | value                    | Description           |
| ----------------- | --------------- | ------------------------ | --------------------- |
| `customer_tier`   | equal           | 1, 2, 3, 4               | à¸£à¸°à¸”à¸±à¸šà¸¥à¸¹à¸à¸„à¹‰à¸²           |
| `route`           | equal           | "Bitkub", "dealer", etc. | à¸Šà¹ˆà¸­à¸‡à¸—à¸²à¸‡à¹à¸¥à¸à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™     |
| `onboarding_day`  | less_than_equal | 7, 30, etc.              | à¸ˆà¸³à¸™à¸§à¸™à¸§à¸±à¸™à¸«à¸¥à¸±à¸‡à¹€à¸›à¸´à¸”à¸šà¸±à¸à¸Šà¸µ |
| `onboarding_date` | more_than_equal | "2025-10-01"             | à¸§à¸±à¸™à¸—à¸µà¹ˆà¹€à¸›à¸´à¸”à¸šà¸±à¸à¸Šà¸µ       |

---

# à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆ 2: GetPossibleFeeRate Function

## 2.1 à¸à¸²à¸£à¸—à¸³à¸‡à¸²à¸™

**à¹„à¸Ÿà¸¥à¹Œ:** `pkg/order_trade/service_fee_rate.go` (à¸šà¸£à¸£à¸—à¸±à¸” 17-87)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    GetPossibleFeeRate                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. getProductAndCustomerAccAndTxnFee                            â”‚
â”‚     â”œâ”€â”€ Get Product by ID                                       â”‚
â”‚     â”œâ”€â”€ Get Customer Account by ID                              â”‚
â”‚     â””â”€â”€ Get Transaction Fee (FEE type) from DB                  â”‚
â”‚                                                                  â”‚
â”‚  2. getPossibleFeeRate                                           â”‚
â”‚     â””â”€â”€ à¸à¸£à¸­à¸‡ Fee à¸—à¸µà¹ˆ Match à¸à¸±à¸šà¹€à¸‡à¸·à¹ˆà¸­à¸™à¹„à¸‚:                            â”‚
â”‚         â”œâ”€â”€ customer_tier match                                  â”‚
â”‚         â”œâ”€â”€ route match                                          â”‚
â”‚         â”œâ”€â”€ onboarding_day match                                 â”‚
â”‚         â””â”€â”€ onboarding_date match                                â”‚
â”‚                                                                  â”‚
â”‚  3. Get Additional Fee (ADDITIONAL_FEE type)                     â”‚
â”‚     â””â”€â”€ à¸à¸£à¸­à¸‡ Fee à¸—à¸µà¹ˆ Match à¸à¸±à¸š symbol + route                      â”‚
â”‚                                                                  â”‚
â”‚  4. validateSelectedFee                                          â”‚
â”‚     â””â”€â”€ à¹€à¸¥à¸·à¸­à¸ Fee à¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡à¸—à¸µà¹ˆà¸ªà¸¸à¸”à¸•à¸²à¸¡ FeeRateType                 â”‚
â”‚         (MIN_FEE_RATE à¸«à¸£à¸·à¸­ MAX_FEE_RATE)                        â”‚
â”‚                                                                  â”‚
â”‚  5. Return []ResponseGetPossibleFeeRate                          â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 2.2 Response Structure

```go
type ResponseGetPossibleFeeRate struct {
    TransactionType        enum.OrderType
    FeeType                string  // "FEE" à¸«à¸£à¸·à¸­ "ADDITIONAL_FEE"
    Name                   string  // à¸Šà¸·à¹ˆà¸­ Fee
    FeeValue               decimal.Decimal // à¸„à¹ˆà¸² Fee à¹€à¸Šà¹ˆà¸™ 0.15
    FeeUnit                string  // "percent"
    IsIncludeAdditionalFee bool    // à¸£à¸§à¸¡ Additional Fee à¸«à¸£à¸·à¸­à¹„à¸¡à¹ˆ
}
```

## 2.3 à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œ

```
Request:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ CustomerAccountId: xxx                                          â”‚
â”‚ TransactionType:   swap                                         â”‚
â”‚ RouteName:         "Bitkub"                                     â”‚
â”‚ ProductId:         yyy                                          â”‚
â”‚ FeeRateType:       MIN_FEE_RATE                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Response:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [                                                               â”‚
â”‚   {                                                             â”‚
â”‚     "fee_type": "FEE",                                          â”‚
â”‚     "name": "Tier 2 Fee",                                       â”‚
â”‚     "fee_value": 0.10,                                          â”‚
â”‚     "fee_unit": "percent",                                      â”‚
â”‚     "is_include_additional_fee": false                          â”‚
â”‚   },                                                            â”‚
â”‚   {                                                             â”‚
â”‚     "fee_type": "ADDITIONAL_FEE",                               â”‚
â”‚     "name": "Bitkub Route Fee",                                 â”‚
â”‚     "fee_value": 0.02,                                          â”‚
â”‚     "fee_unit": "percent",                                      â”‚
â”‚     "is_include_additional_fee": false                          â”‚
â”‚   }                                                             â”‚
â”‚ ]                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆ 3: CalculateTotalFeeRate Function

**à¹„à¸Ÿà¸¥à¹Œ:** `pkg/order_trade/service_fee_rate.go` (à¸šà¸£à¸£à¸—à¸±à¸” 390-398)

```go
func (s *orderTradeService) CalculateTotalFeeRate(feeRate []ResponseGetPossibleFeeRate) decimal.Decimal {
    sum := decimal.Zero
    for _, fee := range feeRate {
        sum = sum.Add(fee.FeeValue)
    }
    return sum
}
```

## 3.1 à¸à¸²à¸£à¸„à¸³à¸™à¸§à¸“

```
totalSwapFee = sum(feeRate[].FeeValue)

à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Input:                                                          â”‚
â”‚   [                                                             â”‚
â”‚     { fee_value: 0.10 },  // Base Fee                          â”‚
â”‚     { fee_value: 0.02 }   // Additional Fee                    â”‚
â”‚   ]                                                             â”‚
â”‚                                                                 â”‚
â”‚ Output:                                                         â”‚
â”‚   totalSwapFee = 0.10 + 0.02 = 0.12%                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆ 4: Flow à¸—à¸µà¹ˆ 1 - GetSwapRoutes

## 4.1 à¸ à¸²à¸à¸£à¸§à¸¡

à¹ƒà¸Šà¹‰à¸•à¸­à¸™à¹à¸ªà¸”à¸‡à¹€à¸ªà¹‰à¸™à¸—à¸²à¸‡à¹à¸¥à¸à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹ƒà¸«à¹‰à¸œà¸¹à¹‰à¹ƒà¸Šà¹‰à¹€à¸¥à¸·à¸­à¸à¸à¹ˆà¸­à¸™à¸ªà¸£à¹‰à¸²à¸‡ Order

## 4.2 BUY Order

**à¹„à¸Ÿà¸¥à¹Œ:** `pkg/order_trade/service.go` (à¸šà¸£à¸£à¸—à¸±à¸” 1266)

```go
feeAmount := s.CalculateFeeAmountForBuy(amount, totalSwapFee)
```

**à¹„à¸Ÿà¸¥à¹Œ:** `pkg/order_trade/service_fee_rate.go` (à¸šà¸£à¸£à¸—à¸±à¸” 416-422)

```go
func (s *orderTradeService) CalculateFeeAmountForBuy(
	placedQuantity decimal.Decimal,
	totalFeePercent decimal.Decimal,
) decimal.Decimal {
	fee := placedQuantity.Mul(totalFeePercent.Div(decimal.NewFromFloat(100).Add(totalFeePercent)))
	return fee.RoundDown(2)
}
```

### à¸ªà¸¹à¸•à¸£ BUY

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ fee = placedQuantity Ã— (feePercent / 100) / (1 + feePercent/100) â”‚
â”‚ fee = RoundDown(fee, 2)                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡ BUY

```
Input:
- placedQuantity (amount) = 10,000 THB
- totalSwapFee = 0.12%

à¸„à¸³à¸™à¸§à¸“:
fee = 10,000 Ã— (0.12 / 100) / (1 + 0.12/100)
    = 10,000 Ã— 0.0012 / 1.0012
    = 12 / 1.0012
    = 11.9856...
    = RoundDown(11.9856, 2)
    = 11.98 THB

TransactionFeeAmount = 11.98 THB
```

## 4.3 SELL Order

**à¹„à¸Ÿà¸¥à¹Œ:** `pkg/order_trade/service.go` (à¸šà¸£à¸£à¸—à¸±à¸” 1350)

```go
feeAmount := s.CalculateFeeAmountForSell(route.MatchedBookAmount(), totalSwapFee)
```

**à¹„à¸Ÿà¸¥à¹Œ:** `pkg/order_trade/service_fee_rate.go` (à¸šà¸£à¸£à¸—à¸±à¸” 400-406)

```go
func (s *orderTradeService) CalculateFeeAmountForSell(
	matchedBookAmount decimal.Decimal,
	feePercent decimal.Decimal,
) decimal.Decimal {
	fee := decimal.RoundNumberDecimal(matchedBookAmount, 2).Mul(feePercent.Div(decimal.NewFromFloat(100)))
	return fee.RoundDown(2)
}
```

### à¸ªà¸¹à¸•à¸£ SELL

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ fee = Round(matchedBookAmount, 2) Ã— (feePercent / 100)            â”‚
â”‚ fee = RoundDown(fee, 2)                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡ SELL

```
Input:
- matchedBookAmount = 9,950.00 THB (à¸ˆà¸²à¸ Remarketer)
- totalSwapFee = 0.12%

à¸„à¸³à¸™à¸§à¸“:
fee = Round(9,950, 2) Ã— (0.12 / 100)
    = 9,950.00 Ã— 0.0012
    = 11.94
    = RoundDown(11.94, 2)
    = 11.94 THB

TransactionFeeAmount = 11.94 THB
```

---

# à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆ 5: Flow à¸—à¸µà¹ˆ 2 - OrderTradeWebhook

## 5.1 à¸ à¸²à¸à¸£à¸§à¸¡

à¹ƒà¸Šà¹‰à¸•à¸­à¸™ Order à¸–à¸¹à¸ Match à¹à¸¥à¹‰à¸§ à¹à¸¥à¸°à¸•à¹‰à¸­à¸‡à¸šà¸±à¸™à¸—à¸¶à¸à¸¥à¸‡ Database

**à¹„à¸Ÿà¸¥à¹Œ:** `pkg/order_trade/webhook_service.go`

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  insertOrderTransactionAndExchange               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. GetPossibleFeeRate (à¸”à¸¶à¸‡ Fee Rate à¸ˆà¸²à¸ DB)                    â”‚
â”‚  2. CalculateTotalFeeRate (à¸£à¸§à¸¡ Fee Rate)                        â”‚
â”‚  3. mapRemarketerWebhookFilledDataToFilledSwap                  â”‚
â”‚     â””â”€â”€ à¸ªà¸£à¹‰à¸²à¸‡ FilledSwap à¸à¸£à¹‰à¸­à¸¡ SwapFee                          â”‚
â”‚  4. filledSwap.OrderFee() â† à¸„à¸³à¸™à¸§à¸“ OrderFee à¸ˆà¸£à¸´à¸‡              â”‚
â”‚  5. filledSwap.Vat() â† à¸„à¸³à¸™à¸§à¸“ VAT                              â”‚
â”‚  6. à¸šà¸±à¸™à¸—à¸¶à¸à¸¥à¸‡ OrderTradeTransaction                              â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 5.2 FilledSwap.OrderFee()

**à¹„à¸Ÿà¸¥à¹Œ:** `internal/domain/filled_swap.go` (à¸šà¸£à¸£à¸—à¸±à¸” 149-163)

```go
func (f FilledSwap) OrderFee() *decimal.Decimal {
    if f.RemarketerWebhookData.OrderSide == string(enum.ORDER_CRYPTO_SWAP_SELL) {
        receivedQuantity := f.ReceivedQuantity()
        return utils.ToPointer(
            decimal.RoundDownDecimal(
                receivedQuantity.Mul(f.SwapFee.Div(decimal.NewFromFloat(100))), 2
            )
        )
    } else { // BUY
        executedQuantity := f.ExecutedQuantity()
        return utils.ToPointer(
            decimal.RoundDownDecimal(
                executedQuantity.Mul(f.SwapFee.Div(decimal.NewFromFloat(100))), 2
            )
        )
    }
}
```

## 5.3 ReceivedQuantity() à¸ªà¸³à¸«à¸£à¸±à¸š SELL

**à¹„à¸Ÿà¸¥à¹Œ:** `internal/domain/filled_swap.go` (à¸šà¸£à¸£à¸—à¸±à¸” 133-147)

```go
func (f FilledSwap) ReceivedQuantity() *decimal.Decimal {
    receivedQuantity, err := f.ReceivedQuantityRemarketer()
    if err != nil {
        return nil
    }
    if f.RemarketerWebhookData.OrderSide == string(enum.ORDER_CRYPTO_SWAP_SELL) {
        exchangeFee, err := f.ExchangeFee()
        if err != nil {
            return nil
        }
        // à¸šà¸§à¸ Exchange Fee à¸à¸¥à¸±à¸šà¹€à¸‚à¹‰à¸²à¹„à¸›!
        receivedQuantityWithExchangeFee := utils.ToNilUnPointer(receivedQuantity).Add(utils.ToNilUnPointer(exchangeFee))
        return utils.ToPointer(decimal.RoundNumberDecimal(receivedQuantityWithExchangeFee, 2))
    }
    return receivedQuantity
}
```

**à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸:** à¸ªà¸³à¸«à¸£à¸±à¸š SELL, system à¸šà¸§à¸ Exchange Fee à¸à¸¥à¸±à¸šà¹€à¸‚à¹‰à¸²à¹„à¸›à¸à¹ˆà¸­à¸™à¸„à¸³à¸™à¸§à¸“ Order Fee

### à¸ªà¸¹à¸•à¸£ SELL (Webhook)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. receivedQuantityFromWebhook = 199.50 THB                     â”‚
â”‚ 2. exchangeFee = 0.50 THB                                        â”‚
â”‚ 3. adjustedReceived = 199.50 + 0.50 = 200.00 THB                â”‚
â”‚ 4. orderFee = 200.00 Ã— (swapFee / 100)                           â”‚
â”‚ 5. orderFee = RoundDown(orderFee, 2)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### à¸ªà¸¹à¸•à¸£ BUY (Webhook)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. executedQuantity = 10,000.00 THB                              â”‚
â”‚ 2. orderFee = 10,000 Ã— (swapFee / 100)                           â”‚
â”‚ 3. orderFee = RoundDown(orderFee, 2)                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 5.4 à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡ Webhook SELL

### Input à¸ˆà¸²à¸ Remarketer Webhook (à¸ˆà¸£à¸´à¸‡)

```json
{
  "remarketer_order_id": "REM-20250102-001",
  "exchange": "Bitkub",
  "exchange_order_id": "BK-123456",
  "exchange_order_date": "2025-01-02T10:30:00Z",
  "order_type": "MARKET",
  "order_side": "SELL",
  "symbol": "THB",
  "symbol_pair": "BTC",
  "placed_quantity": "0.00010000",
  "placed_quantity_exchange": "0.00010000",
  "executed_quantity": "0.00010000",
  "received_quantity": "199.50",
  "remaining_quantity": "0.00000000",
  "executed_price": "1995000.00",
  "match_date": "2025-01-02T10:30:15Z",
  "fx_rate": "1.00",
  "exchange_fee": "0.50",
  "status": "filled",
  "post_order_type": "LP",
  "exchanges": [
    {
      "symbol": "THB",
      "symbol_pair": "BTC",
      "executed_quantity": "0.00010000",
      "received_quantity": "199.50",
      "executed_price": "1995000.00",
      "match_date": "2025-01-02T10:30:15Z",
      "exchange_fee": "0.50"
    }
  ]
}
```

### à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²à¹à¸¥à¸° Fee Rate

| à¸£à¸²à¸¢à¸à¸²à¸£ | à¸„à¹ˆà¸² |
|---------|-----|
| Customer Tier | Tier 2 |
| Route | Bitkub |
| Base Fee (Tier 2) | 0.10% |
| Additional Fee (Bitkub) | 0.02% |
| **Total SwapFee** | **0.12%** |

### à¸à¸²à¸£à¸„à¸³à¸™à¸§à¸“à¸—à¸µà¸¥à¸°à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ Webhook                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ order_side = "SELL"                                              â”‚
â”‚ received_quantity = 199.50 THB    â† à¹€à¸‡à¸´à¸™à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸£à¸±à¸š (à¸«à¸±à¸ exchange_fee à¹à¸¥à¹‰à¸§) â”‚
â”‚ exchange_fee = 0.50 THB           â† à¸„à¹ˆà¸²à¸˜à¸£à¸£à¸¡à¹€à¸™à¸µà¸¢à¸¡à¸ˆà¸²à¸ Exchange         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: à¸šà¸§à¸ Exchange Fee à¸à¸¥à¸±à¸šà¹€à¸‚à¹‰à¸²à¹„à¸› (ReceivedQuantity)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ adjustedReceived = 199.50 + 0.50 = 200.00 THB                   â”‚
â”‚                                                                  â”‚
â”‚ â€» à¸—à¸³à¹„à¸¡à¸•à¹‰à¸­à¸‡à¸šà¸§à¸à¸à¸¥à¸±à¸š?                                           â”‚
â”‚   - Webhook à¸ªà¹ˆà¸‡ received_quantity à¸—à¸µà¹ˆà¸«à¸±à¸ exchange_fee à¸­à¸­à¸à¹à¸¥à¹‰à¸§      â”‚
â”‚   - à¹à¸•à¹ˆà¹€à¸£à¸²à¸•à¹‰à¸­à¸‡à¸„à¸³à¸™à¸§à¸“ OrderFee à¸ˆà¸²à¸à¸¢à¸­à¸”à¹€à¸•à¹‡à¸¡ (à¸à¹ˆà¸­à¸™à¸«à¸±à¸ exchange_fee) â”‚
â”‚   - à¸ˆà¸¶à¸‡à¸•à¹‰à¸­à¸‡à¸šà¸§à¸ exchange_fee à¸à¸¥à¸±à¸šà¹€à¸‚à¹‰à¸²à¹„à¸›à¸à¹ˆà¸­à¸™à¸„à¸³à¸™à¸§à¸“               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: à¸„à¸³à¸™à¸§à¸“ OrderFee                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ orderFee = adjustedReceived Ã— (swapFee / 100)                   â”‚
â”‚ orderFee = 200.00 Ã— (0.12 / 100)                                â”‚
â”‚ orderFee = 200.00 Ã— 0.0012                                      â”‚
â”‚ orderFee = 0.24 THB                                             â”‚
â”‚                                                                  â”‚
â”‚ RoundDown(0.24, 2) = 0.24 THB                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: à¸„à¸³à¸™à¸§à¸“ VAT                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ vat = orderFee Ã— 7 / 107                                         â”‚
â”‚ vat = 0.24 Ã— 7 / 107                                             â”‚
â”‚ vat = 1.68 / 107                                                 â”‚
â”‚ vat = 0.0157...                                                  â”‚
â”‚ vat = Round(0.0157, 2) = 0.02 THB                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: à¸„à¸³à¸™à¸§à¸“ NetReceivedQuantity (à¹€à¸‡à¸´à¸™à¸—à¸µà¹ˆà¸¥à¸¹à¸à¸„à¹‰à¸²à¹„à¸”à¹‰à¸£à¸±à¸šà¸ªà¸¸à¸—à¸˜à¸´)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â€» à¹‚à¸„à¹‰à¸”à¸ˆà¸£à¸´à¸‡: NetReceivedQuantity = ReceivedQuantity() - OrderFee â”‚
â”‚                                                                  â”‚
â”‚ Where:                                                           â”‚
â”‚   ReceivedQuantity() = received_quantity + exchange_fee         â”‚
â”‚                      = 199.50 + 0.50 = 200.00 THB                â”‚
â”‚   OrderFee = 0.24 THB                                            â”‚
â”‚                                                                  â”‚
â”‚ netReceived = ReceivedQuantity() - OrderFee                     â”‚
â”‚ netReceived = 200.00 - 0.24                                      â”‚
â”‚ netReceived = 199.76 THB                                         â”‚
â”‚                                                                  â”‚
â”‚ â€» à¸ªà¸±à¸‡à¹€à¸à¸•: à¹‚à¸„à¹‰à¸”à¸«à¸±à¸ OrderFee à¸ˆà¸²à¸à¸¢à¸­à¸”à¸—à¸µà¹ˆà¸šà¸§à¸ exchange_fee à¹à¸¥à¹‰à¸§         â”‚
â”‚           (à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸«à¸±à¸à¸ˆà¸²à¸ received_quantity à¸•à¹‰à¸™à¸—à¸²à¸‡ 199.50)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### à¸ªà¸£à¸¸à¸›à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œ

| à¸£à¸²à¸¢à¸à¸²à¸£ | à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™ | à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸ |
|---------|-----------|----------|
| **received_quantity** (à¸ˆà¸²à¸ Webhook) | 199.50 THB | à¹€à¸‡à¸´à¸™à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸ˆà¸²à¸à¸à¸²à¸£à¸‚à¸²à¸¢ BTC (à¸«à¸±à¸ exchange_fee à¹à¸¥à¹‰à¸§) |
| **exchange_fee** | 0.50 THB | à¸„à¹ˆà¸²à¸˜à¸£à¸£à¸¡à¹€à¸™à¸µà¸¢à¸¡ Exchange |
| **ReceivedQuantity()** (à¸šà¸§à¸ exchange_fee à¸à¸¥à¸±à¸š) | 200.00 THB | à¸¢à¸­à¸”à¹€à¸•à¹‡à¸¡à¸à¹ˆà¸­à¸™à¸«à¸±à¸ exchange_fee à¹ƒà¸Šà¹‰à¸ªà¸³à¸«à¸£à¸±à¸šà¸„à¸³à¸™à¸§à¸“ OrderFee |
| **OrderFee (à¸„à¸³à¸™à¸§à¸“à¹„à¸”à¹‰)** | **0.24 THB** | à¸„à¹ˆà¸²à¸˜à¸£à¸£à¸¡à¹€à¸™à¸µà¸¢à¸¡ XAS (0.12% à¸‚à¸­à¸‡ 200.00) |
| **VAT** | 0.02 THB | à¸ à¸²à¸©à¸µà¸¡à¸¹à¸¥à¸„à¹ˆà¸²à¹€à¸à¸´à¹ˆà¸¡ |
| **net_received_quantity** | 199.76 THB | à¹€à¸‡à¸´à¸™à¸—à¸µà¹ˆà¸¥à¸¹à¸à¸„à¹‰à¸²à¹„à¸”à¹‰à¸£à¸±à¸šà¸ªà¸¸à¸—à¸˜à¸´ (200.00 - 0.24) |

### à¸„à¸³à¸–à¸²à¸¡: OrderFee à¸«à¸±à¸à¸ˆà¸²à¸à¹„à¸«à¸™?

**Answer: à¸ˆà¸²à¸à¹‚à¸„à¹‰à¸”à¸ˆà¸£à¸´à¸‡:**

```
Webhook: received_quantity = 199.50 THB
                â†“
ReceivedQuantity(): 199.50 + 0.50 = 200.00 THB  â† à¸šà¸§à¸ exchange_fee à¸à¸¥à¸±à¸š
                â†“
OrderFee = 200.00 Ã— 0.0012 = 0.24 THB
                â†“
NetReceivedQuantity = 200.00 - 0.24 = 199.76 THB  â† à¸«à¸±à¸à¸ˆà¸²à¸ 200.00
```

**à¸ªà¸£à¸¸à¸›:**
1. OrderFee à¸„à¸³à¸™à¸§à¸“à¸ˆà¸²à¸à¸¢à¸­à¸”à¹€à¸•à¹‡à¸¡ 200.00 THB â†’ à¹„à¸”à¹‰ 0.24 THB
2. NetReceivedQuantity à¸«à¸±à¸ OrderFee à¸­à¸­à¸à¸ˆà¸²à¸ **ReceivedQuantity() (200.00)**
3. à¹€à¸‡à¸´à¸™à¸—à¸µà¹ˆà¸¥à¸¹à¸à¸„à¹‰à¸²à¹„à¸”à¹‰à¸£à¸±à¸šà¸ªà¸¸à¸—à¸˜à¸´ = **200.00 - 0.24 = 199.76 THB**

âš ï¸ **à¸ªà¸±à¸‡à¹€à¸à¸•:** à¹‚à¸„à¹‰à¸”à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸«à¸±à¸ OrderFee à¸ˆà¸²à¸ received_quantity (199.50) à¹‚à¸”à¸¢à¸•à¸£à¸‡
- à¹à¸•à¹ˆà¸šà¸§à¸ exchange_fee à¸à¸¥à¸±à¸šà¹€à¸‚à¹‰à¸²à¹„à¸›à¸à¹ˆà¸­à¸™ â†’ 200.00
- à¹à¸¥à¹‰à¸§à¸„à¹ˆà¸­à¸¢à¸«à¸±à¸ OrderFee à¸­à¸­à¸ â†’ 199.76

## 5.5 à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡ Webhook BUY

### Input à¸ˆà¸²à¸ Remarketer Webhook (à¸ˆà¸£à¸´à¸‡)

```json
{
  "remarketer_order_id": "REM-20250102-002",
  "exchange": "Bitkub",
  "exchange_order_id": "BK-789012",
  "exchange_order_date": "2025-01-02T11:00:00Z",
  "order_type": "MARKET",
  "order_side": "BUY",
  "symbol": "THB",
  "symbol_pair": "BTC",
  "placed_quantity": "10000.00",
  "placed_quantity_exchange": "0.00050000",
  "executed_quantity": "10000.00",
  "received_quantity": "0.00492500",
  "remaining_quantity": "0.00",
  "executed_price": "2030455.65",
  "match_date": "2025-01-02T11:00:20Z",
  "fx_rate": "1.00",
  "exchange_fee": "10.00",
  "status": "filled",
  "post_order_type": "LP",
  "exchanges": [
    {
      "symbol": "THB",
      "symbol_pair": "BTC",
      "executed_quantity": "10000.00",
      "received_quantity": "0.00492500",
      "executed_price": "2030455.65",
      "match_date": "2025-01-02T11:00:20Z",
      "exchange_fee": "10.00"
    }
  ]
}
```

### à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²à¹à¸¥à¸° Fee Rate

| à¸£à¸²à¸¢à¸à¸²à¸£ | à¸„à¹ˆà¸² |
|---------|-----|
| Customer Tier | Tier 2 |
| Route | Bitkub |
| Base Fee (Tier 2) | 0.10% |
| Additional Fee (Bitkub) | 0.02% |
| **Total SwapFee** | **0.12%** |

### à¸à¸²à¸£à¸„à¸³à¸™à¸§à¸“à¸—à¸µà¸¥à¸°à¸‚à¸±à¹‰à¸™à¸•à¸­à¸™

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: à¸”à¸¶à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸²à¸ Webhook                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ order_side = "BUY"                                               â”‚
â”‚ executed_quantity = 10,000.00 THB   â† à¹€à¸‡à¸´à¸™à¸—à¸µà¹ˆà¸¥à¸¹à¸à¸„à¹‰à¸²à¸ˆà¹ˆà¸²à¸¢à¹„à¸›     â”‚
â”‚ received_quantity = 0.00492500 BTC  â† BTC à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸£à¸±à¸š             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: à¸„à¸³à¸™à¸§à¸“ OrderFee (à¸ªà¸³à¸«à¸£à¸±à¸š BUY à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸šà¸§à¸ exchange_fee)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ orderFee = executedQuantity Ã— (swapFee / 100)                   â”‚
â”‚ orderFee = 10,000.00 Ã— (0.12 / 100)                             â”‚
â”‚ orderFee = 10,000.00 Ã— 0.0012                                   â”‚
â”‚ orderFee = 12.00 THB                                             â”‚
â”‚                                                                  â”‚
â”‚ RoundDown(12.00, 2) = 12.00 THB                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: à¸„à¸³à¸™à¸§à¸“ VAT                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ vat = orderFee Ã— 7 / 107                                         â”‚
â”‚ vat = 12.00 Ã— 7 / 107                                            â”‚
â”‚ vat = 84.00 / 107                                                â”‚
â”‚ vat = 0.7850...                                                  â”‚
â”‚ vat = Round(0.7850, 2) = 0.79 THB                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: à¸„à¸³à¸™à¸§à¸“ NetReceivedQuantity (BTC à¸—à¸µà¹ˆà¸¥à¸¹à¸à¸„à¹‰à¸²à¹„à¸”à¹‰à¸£à¸±à¸šà¸ªà¸¸à¸—à¸˜à¸´)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ netReceivedBTC = received_quantity                              â”‚
â”‚               = 0.00492500 BTC                                   â”‚
â”‚                                                                  â”‚
â”‚ (à¸ªà¸³à¸«à¸£à¸±à¸š BUY, OrderFee à¸«à¸±à¸à¸ˆà¸²à¸ executed_quantity/THB              â”‚
â”‚  à¹„à¸¡à¹ˆà¹„à¸”à¹‰à¸«à¸±à¸à¸ˆà¸²à¸ received_quantity/BTC)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### à¸ªà¸£à¸¸à¸›à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œ

| à¸£à¸²à¸¢à¸à¸²à¸£ | à¸ˆà¸³à¸™à¸§à¸™à¹€à¸‡à¸´à¸™ | à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸ |
|---------|-----------|----------|
| **executed_quantity** (à¸ˆà¸²à¸ Webhook) | 10,000.00 THB | à¹€à¸‡à¸´à¸™à¸—à¸µà¹ˆà¸¥à¸¹à¸à¸„à¹‰à¸²à¸ˆà¹ˆà¸²à¸¢ |
| **received_quantity** | 0.00492500 BTC | BTC à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸£à¸±à¸š |
| **OrderFee (à¸„à¸³à¸™à¸§à¸“à¹„à¸”à¹‰)** | **12.00 THB** | à¸„à¹ˆà¸²à¸˜à¸£à¸£à¸¡à¹€à¸™à¸µà¸¢à¸¡ XAS (0.12% à¸‚à¸­à¸‡ 10,000) |
| **VAT** | 0.79 THB | à¸ à¸²à¸©à¸µà¸¡à¸¹à¸¥à¸„à¹ˆà¸²à¹€à¸à¸´à¹ˆà¸¡ |
| **net_received_quantity** | 0.00492500 BTC | BTC à¸—à¸µà¹ˆà¸¥à¸¹à¸à¸„à¹‰à¸²à¹„à¸”à¹‰à¸£à¸±à¸šà¸ªà¸¸à¸—à¸˜à¸´ |

### à¸„à¸§à¸²à¸¡à¹à¸•à¸à¸•à¹ˆà¸²à¸‡à¸£à¸°à¸«à¸§à¹ˆà¸²à¸‡ BUY à¹à¸¥à¸° SELL

| à¸”à¹‰à¸²à¸™ | à¸à¸²à¸™à¹ƒà¸™à¸à¸²à¸£à¸„à¸³à¸™à¸§à¸“ OrderFee | OrderFee à¸«à¸±à¸à¸ˆà¸²à¸ |
|------|-------------------------|------------------|
| **BUY** | executed_quantity (THB) | à¸«à¸±à¸à¸ˆà¸²à¸ THB à¸—à¸µà¹ˆà¸ˆà¹ˆà¸²à¸¢ |
| **SELL** | adjustedReceived (THB + exchange_fee) | à¸«à¸±à¸à¸ˆà¸²à¸ received_quantity (THB à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸£à¸±à¸š) |

---

## 5.6 Edge Case: à¹€à¸¡à¸·à¹ˆà¸­ OrderFee > exchange_fee

### à¸›à¸±à¸à¸«à¸²

à¸ˆà¸²à¸à¹‚à¸„à¹‰à¸” `filled_swap.go:133-178` à¸ªà¸³à¸«à¸£à¸±à¸š SELL:
- `ReceivedQuantity()` à¸šà¸§à¸ `exchange_fee` à¸à¸¥à¸±à¸šà¹€à¸‚à¹‰à¸²à¹„à¸› â†’ `199.50 + 0.50 = 200.00`
- `OrderFee` à¸„à¸³à¸™à¸§à¸“à¸ˆà¸²à¸ `ReceivedQuantity()` â†’ `200.00 Ã— 0.12% = 0.24`
- `NetReceivedQuantity` = `ReceivedQuantity() - OrderFee` â†’ `200.00 - 0.24 = 199.76`

**à¹à¸•à¹ˆà¸–à¹‰à¸² OrderFee > exchange_fee à¸ˆà¸°à¹€à¸à¸´à¸”à¸­à¸°à¹„à¸£à¸‚à¸¶à¹‰à¸™?**

### à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸à¸£à¸“à¸µ OrderFee à¸ªà¸¹à¸‡

```
Input:
- received_quantity = 199.50 THB
- exchange_fee = 0.10 THB (à¸•à¹ˆà¸³)
- swap_fee_rate = 0.50% (à¸ªà¸¹à¸‡)

à¸„à¸³à¸™à¸§à¸“:
1. ReceivedQuantity() = 199.50 + 0.10 = 199.60 THB
2. OrderFee = 199.60 Ã— 0.005 = 0.99 THB â† OrderFee > exchange_fee!
3. NetReceivedQuantity = 199.60 - 0.99 = 198.61 THB

à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œ:
- à¸¥à¸¹à¸à¸„à¹‰à¸²à¹„à¸”à¹‰à¸ˆà¸²à¸ Exchange: 199.50 THB
- à¸¥à¸¹à¸à¸„à¹‰à¸²à¹„à¸”à¹‰à¸ªà¸¸à¸—à¸˜à¸´: 198.61 THB
- à¹€à¸ªà¸µà¸¢à¸›à¸£à¸°à¹‚à¸¢à¸Šà¸™à¹Œ: -0.89 THB âš ï¸
```

### à¹€à¸›à¸£à¸µà¸¢à¸šà¹€à¸—à¸µà¸¢à¸šà¸à¸£à¸“à¸µ

| Case | received_qty | exchange_fee | fee_rate | OrderFee | NetReceived | à¸œà¸¥ |
|------|--------------|--------------|----------|----------|-------------|-----|
| **à¸›à¸à¸•à¸´** | 199.50 | 0.50 | 0.12% | 0.24 | 199.76 | âœ… à¹„à¸”à¹‰à¸¡à¸²à¸à¸à¸§à¹ˆà¸² |
| **OrderFee > ex.fee** | 199.50 | 0.10 | 0.50% | 0.99 | 198.61 | âš ï¸ à¹€à¸ªà¸µà¸¢à¹€à¸›à¸£à¸µà¸¢à¸š |
| **à¸§à¸´à¸à¸¤à¸•** | 100.00 | 0.50 | 5.00% | 5.02 | 95.48 | ğŸ”´ à¹€à¸ªà¸µà¸¢à¹€à¸¢à¸­à¸° |

### à¹‚à¸„à¹‰à¸”à¸¡à¸µ validation à¹„à¸«à¸¡?

**à¹„à¸Ÿà¸¥à¹Œ:** `pkg/order_trade/webhook_service.go:497-555`

```go
func (s *orderTradeService) validateFilledSwap(filledSwap domain.FilledSwap) {
    // âœ“ à¹€à¸Šà¹‡à¸„à¹à¸„à¹ˆ parsing à¸‚à¹‰à¸­à¸¡à¸¹à¸¥:
    matchDate, executedPrice, executedQuantity, receivedQuantity, exchangeFee

    // âœ— à¹„à¸¡à¹ˆà¸¡à¸µà¹€à¸Šà¹‡à¸„ business logic:
    // - OrderFee à¹€à¸—à¸µà¸¢à¸šà¸à¸±à¸š exchange_fee?
    // - NetReceivedQuantity >= received_quantity?
}
```

**à¸ªà¸£à¸¸à¸›:** à¹‚à¸„à¹‰à¸”à¸•à¸­à¸™à¸™à¸µà¹‰ **à¹„à¸¡à¹ˆà¸¡à¸µ validation** à¸ªà¸³à¸«à¸£à¸±à¸šà¸à¸£à¸“à¸µà¸™à¸µà¹‰ â†’ à¸ˆà¸°à¸„à¸³à¸™à¸§à¸“à¹„à¸”à¹‰à¸›à¸à¸•à¸´à¹à¸¡à¹‰ OrderFee > exchange_fee

---

# à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆ 6: VAT Calculation

**à¹„à¸Ÿà¸¥à¹Œ:** `internal/domain/filled_swap.go` (à¸šà¸£à¸£à¸—à¸±à¸” 166-171)

```go
func (f FilledSwap) Vat() *decimal.Decimal {
    if f.OrderFee() == nil {
        return nil
    }
    return utils.ToPointer(
        decimal.RoundNumberDecimal(
            utils.ToNilUnPointer(f.OrderFee()).Mul(decimal.NewFromInt(7)).Div(decimal.NewFromInt(107)),
            2
        )
    )
}
```

## à¸ªà¸¹à¸•à¸£ VAT

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ vat = orderFee Ã— 7 / 107                                         â”‚
â”‚ vat = Round(vat, 2)                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**à¸«à¸¡à¸²à¸¢à¹€à¸«à¸•à¸¸:** à¸™à¸µà¹ˆà¸„à¸·à¸­à¸ªà¸¹à¸•à¸£ VAT à¹à¸šà¸šà¸£à¸§à¸¡à¸ à¸²à¸©à¸µ (Included)

### à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡ VAT

```
OrderFee = 11.98 THB

vat = 11.98 Ã— 7 / 107
    = 83.86 / 107
    = 0.7837...
    = Round(0.7837, 2)
    = 0.78 THB

VAT = 0.78 THB
```

---

# à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆ 7: à¸ªà¸£à¸¸à¸›à¸ªà¸¹à¸•à¸£à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”

## 7.1 GetSwapRoutes Flow

| à¸”à¹‰à¸²à¸™ | à¸ªà¸¹à¸•à¸£ OrderFee |
|------|---------------|
| **BUY** | `amount Ã— (feeRate/100) / (1 + feeRate/100)` |
| **SELL** | `matchedBookAmount Ã— (feeRate/100)` |

## 7.2 OrderTradeWebhook Flow

| à¸”à¹‰à¸²à¸™ | à¸ªà¸¹à¸•à¸£ OrderFee |
|------|---------------|
| **BUY** | `executedQuantity Ã— (swapFee/100)` |
| **SELL** | `(receivedQty + exchangeFee) Ã— (swapFee/100)` |

## 7.3 VAT (à¹€à¸«à¸¡à¸·à¸­à¸™à¸à¸±à¸™à¸—à¸¸à¸ Flow)

```
VAT = OrderFee Ã— 7 / 107
```

---

# à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆ 8: Flow Diagram à¸‰à¸šà¸±à¸šà¸ªà¸¡à¸šà¸¹à¸£à¸“à¹Œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      User Request                               â”‚
â”‚                  (Create Swap Order)                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     GetSwapRoutes                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. GetPossibleFeeRate                                    â”‚   â”‚
â”‚  â”‚    â””â”€â”€ Query transaction_fee table                       â”‚   â”‚
â”‚  â”‚                                                              â”‚
â”‚  â”‚ 2. CalculateTotalFeeRate                                 â”‚   â”‚
â”‚  â”‚    â””â”€â”€ sum(all fee_value)                                â”‚   â”‚
â”‚  â”‚                                                              â”‚
â”‚  â”‚ 3. CalculateFeeAmountForBuy/Sell                          â”‚   â”‚
â”‚  â”‚    â””â”€â”€ amount Ã— feeRate / 100                            â”‚   â”‚
â”‚  â”‚                                                              â”‚
â”‚  â”‚ 4. Return Routes with TransactionFeeAmount               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   User Select Route & Confirm                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Create Swap Order                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 OrderTradeWebhook (Matched)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. GetPossibleFeeRate (à¹ƒà¸«à¸¡à¹ˆ)                              â”‚   â”‚
â”‚  â”‚    â””â”€â”€ Query transaction_fee table                       â”‚   â”‚
â”‚  â”‚                                                              â”‚
â”‚  â”‚ 2. CalculateTotalFeeRate                                 â”‚   â”‚
â”‚  â”‚    â””â”€â”€ totalSwapFee = sum(all fee_value)                  â”‚   â”‚
â”‚  â”‚                                                              â”‚
â”‚  â”‚ 3. Create FilledSwap(totalSwapFee)                        â”‚   â”‚
â”‚  â”‚                                                              â”‚
â”‚  â”‚ 4. filledSwap.OrderFee()                                  â”‚   â”‚
â”‚  â”‚    BUY:  executedQty Ã— (swapFee/100)                     â”‚   â”‚
â”‚  â”‚    SELL: (receivedQty + exchangeFee) Ã— (swapFee/100)      â”‚   â”‚
â”‚  â”‚                                                              â”‚
â”‚  â”‚ 5. filledSwap.Vat()                                      â”‚   â”‚
â”‚  â”‚    vat = orderFee Ã— 7 / 107                              â”‚   â”‚
â”‚  â”‚                                                              â”‚
â”‚  â”‚ 6. Save to OrderTradeTransaction                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆ 9: à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¹ƒà¸™ Database

## 9.1 à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡ transaction_fee rows

```sql
-- Base Fee (Default)
INSERT INTO transaction_fee (
    id, company_code, transaction_type, fee_type, priority, condition,
    fee_value, fee_unit, start_date, name, is_include_additional_fee
) VALUES (
    'base-fee-001', 'XD', 'swap', 'FEE', 100, '[]',
    0.15, 'percent', '2024-07-01 00:00:00', 'Base Fee', false
);

-- Customer Tier 1 Fee
INSERT INTO transaction_fee (
    id, company_code, transaction_type, fee_type, priority, condition,
    fee_value, fee_unit, start_date, name
) VALUES (
    'tier1-fee-001', 'XD', 'swap', 'FEE', 100,
    '[{"param_name": "customer_tier", "operator": "equal", "value": "1"}]',
    0.12, 'percent', '2024-07-01 00:00:00', 'Tier 1 Fee'
);

-- Tier 2
INSERT INTO transaction_fee (
    id, company_code, transaction_type, fee_type, priority, condition,
    fee_value, fee_unit, start_date, name
) VALUES (
    'tier2-fee-001', 'XD', 'swap', 'FEE', 100,
    '[{"param_name": "customer_tier", "operator": "equal", "value": "2"}]',
    0.10, 'percent', '2024-07-01 00:00:00', 'Tier 2 Fee'
);

-- Tier 3
INSERT INTO transaction_fee (
    id, company_code, transaction_type, fee_type, priority, condition,
    fee_value, fee_unit, start_date, name
) VALUES (
    'tier3-fee-001', 'XD', 'swap', 'FEE', 100,
    '[{"param_name": "customer_tier", "operator": "equal", "value": "3"}]',
    0.08, 'percent', '2024-07-01 00:00:00', 'Tier 3 Fee'
);

-- Tier 4
INSERT INTO transaction_fee (
    id, company_code, transaction_type, fee_type, priority, condition,
    fee_value, fee_unit, start_date, name
) VALUES (
    'tier4-fee-001', 'XD', 'swap', 'FEE', 100,
    '[{"param_name": "customer_tier", "operator": "equal", "value": "4"}]',
    0.05, 'percent', '2024-07-01 00:00:00', 'Tier 4 Fee'
);

-- Bitkub Additional Fee
INSERT INTO transaction_fee (
    id, company_code, transaction_type, fee_type, priority, condition,
    fee_value, fee_unit, start_date, name, is_include_additional_fee
) VALUES (
    'bitkub-add-001', 'XD', 'swap', 'ADDITIONAL_FEE', 1,
    '[{"param_name": "route", "operator": "equal", "value": "Bitkub"}]',
    0.02, 'percent', '2025-07-07 00:00:00', 'Bitkub Route Fee', false
);

-- Dealer Fee (Sirihub 2) - Include Additional
INSERT INTO transaction_fee (
    id, company_code, transaction_type, fee_type, priority, condition,
    fee_value, fee_unit, start_date, name, is_include_additional_fee
) VALUES (
    'dealer-fee-001', 'XD', 'swap', 'FEE', 1,
    '[{"param_name": "route", "operator": "equal", "value": "dealer"}]',
    0.15, 'percent', '2025-12-01 00:00:00', 'Dealer Fee', true
);

-- Onboarding Day Promotion (7 days)
INSERT INTO transaction_fee (
    id, company_code, transaction_type, fee_type, priority, condition,
    fee_value, fee_unit, start_date, end_date, name, is_campaign
) VALUES (
    'onboard-7d-001', 'XD', 'swap', 'FEE', 50,
    '[{"param_name": "onboarding_day", "operator": "less_than_equal", "value": 7}]',
    0.13, 'percent', '2025-10-08 00:00:00', NULL, 'New User 7 Days', true
);

-- Onboarding Date Range Promotion
INSERT INTO transaction_fee (
    id, company_code, transaction_type, fee_type, priority, condition,
    fee_value, fee_unit, start_date, end_date, name, is_campaign
) VALUES (
    'onboard-date-001', 'XD', 'swap', 'FEE', 50,
    '[{"param_name": "onboarding_date", "operator": "more_than_equal", "value": "2025-10-01"}]',
    0.11, 'percent', '2025-10-01 00:00:00', '2025-10-31 23:59:59', 'October Promo', true
);
```

## 9.2 à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸à¸²à¸£ Match Fee

```
à¸¥à¸¹à¸à¸„à¹‰à¸²: Tier 2, à¹€à¸›à¸´à¸”à¸šà¸±à¸à¸Šà¸µ 30 à¸§à¸±à¸™à¹à¸¥à¹‰à¸§, Route = Bitkub

GetPossibleFeeRate Match:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Name           â”‚ Priority â”‚ Match?  â”‚ FeeValue  â”‚ IncludeAdd? â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Base Fee       â”‚ 100      â”‚ âœ“       â”‚ 0.15      â”‚ false       â”‚
â”‚ Tier 2 Fee     â”‚ 100      â”‚ âœ“       â”‚ 0.10      â”‚ false       â”‚ â† à¹€à¸¥à¸·à¸­à¸ (MIN)
â”‚ Tier 1 Fee     â”‚ 100      â”‚ âœ—       â”‚ 0.12      â”‚ false       â”‚
â”‚ Tier 3 Fee     â”‚ 100      â”‚ âœ—       â”‚ 0.08      â”‚ false       â”‚
â”‚ Tier 4 Fee     â”‚ 100      â”‚ âœ—       â”‚ 0.05      â”‚ false       â”‚
â”‚ Bitkub Add     â”‚ 1        â”‚ âœ“       â”‚ 0.02      â”‚ false       â”‚
â”‚ Dealer Fee     â”‚ 1        â”‚ âœ—       â”‚ 0.15      â”‚ true        â”‚
â”‚ 7 Days Promo   â”‚ 50       â”‚ âœ—       â”‚ 0.13      â”‚ false       â”‚
â”‚ October Promo  â”‚ 50       â”‚ âœ—       â”‚ 0.11      â”‚ false       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

à¸œà¸¥à¸¥à¸±à¸à¸˜à¹Œ (MIN_FEE_RATE):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Selected Fee   â”‚ FeeValue  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Tier 2 Fee     â”‚ 0.10      â”‚
â”‚ Bitkub Add     â”‚ 0.02      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Total Fee Rate â”‚ 0.12%     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

# à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆ 10: à¸„à¸³à¸–à¸²à¸¡à¸—à¸µà¹ˆà¸à¸šà¸šà¹ˆà¸­à¸¢

## Q1: à¸—à¸³à¹„à¸¡ GetSwapRoutes à¸à¸±à¸š Webhook à¸„à¸³à¸™à¸§à¸“à¸•à¹ˆà¸²à¸‡à¸à¸±à¸™?

**A:**
- **GetSwapRoutes**: à¸„à¸³à¸™à¸§à¸“à¹à¸šà¸šà¸›à¸£à¸°à¸¡à¸²à¸“à¸à¸²à¸£ à¹€à¸à¸·à¹ˆà¸­à¹à¸ªà¸”à¸‡à¸œà¸¥à¹ƒà¸«à¹‰à¸¥à¸¹à¸à¸„à¹‰à¸²à¸”à¸¹
- **Webhook**: à¸„à¸³à¸™à¸§à¸“à¸„à¹ˆà¸²à¸ˆà¸£à¸´à¸‡à¸—à¸µà¹ˆ Match à¹„à¸”à¹‰ à¸ˆà¸²à¸ Remarketer

## Q2: à¸—à¸³à¹„à¸¡ SELL à¸•à¹‰à¸­à¸‡à¸šà¸§à¸ Exchange Fee à¸à¸¥à¸±à¸š?

**A:** à¹€à¸à¸£à¸²à¸° Webhook à¸ªà¹ˆà¸‡ `received_quantity` à¸—à¸µà¹ˆà¸«à¸±à¸ Exchange Fee à¸­à¸­à¸à¹à¸¥à¹‰à¸§
- à¹à¸•à¹ˆà¹€à¸£à¸²à¸•à¹‰à¸­à¸‡à¸„à¸³à¸™à¸§à¸“ OrderFee à¸ˆà¸²à¸à¸ˆà¸³à¸™à¸§à¸™à¹€à¸•à¹‡à¸¡
- à¸ˆà¸¶à¸‡à¸•à¹‰à¸­à¸‡à¸šà¸§à¸ Exchange Fee à¸à¸¥à¸±à¸šà¹€à¸‚à¹‰à¸²à¹„à¸›à¸à¹ˆà¸­à¸™à¸„à¸³à¸™à¸§à¸“

## Q3: VAT à¸„à¸³à¸™à¸§à¸“à¸¢à¸±à¸‡à¹„à¸‡?

**A:** à¹ƒà¸Šà¹‰à¸ªà¸¹à¸•à¸£à¸£à¸§à¸¡à¸ à¸²à¸©à¸µ
```
VAT = OrderFee Ã— 7 / 107
(à¹„à¸¡à¹ˆà¹ƒà¸Šà¹ˆ OrderFee Ã— 7%)
```

## Q4: Fee Rate à¸¡à¸µà¸à¸µà¹ˆà¸›à¸£à¸°à¹€à¸ à¸—?

**A:** 2 à¸›à¸£à¸°à¹€à¸ à¸—à¸«à¸¥à¸±à¸:
1. **FEE** - Base Fee
2. **ADDITIONAL_FEE** - Additional Fee (à¸šà¸™ Base)

---

# à¸ªà¹ˆà¸§à¸™à¸—à¸µà¹ˆ 11: à¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸à¸„à¸³à¸™à¸§à¸“ OrderFee à¹à¸¥à¹‰à¸§ - à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥

## 11.1 à¸ à¸²à¸à¸£à¸§à¸¡ Flow à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸à¸‚à¹‰à¸­à¸¡à¸¹à¸¥

**à¹„à¸Ÿà¸¥à¹Œ:** `pkg/order_trade/webhook_service.go`

à¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸à¸„à¸³à¸™à¸§à¸“ OrderFee à¹à¸¥à¸° VAT à¹€à¸ªà¸£à¹‡à¸ˆà¹à¸¥à¹‰à¸§ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸°à¸–à¸¹à¸à¸šà¸±à¸™à¸—à¸¶à¸à¸¥à¸‡ Database à¹à¸¥à¸°à¸”à¸³à¹€à¸™à¸´à¸™à¸à¸²à¸£à¸•à¹ˆà¸­à¹„à¸›

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         insertOrderTransactionAndExchange (Line 391-495)         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. GetPossibleFeeRate                                          â”‚
â”‚     â””â”€â”€ à¸”à¸¶à¸‡ Fee Rate à¸ˆà¸²à¸ transaction_fee table                   â”‚
â”‚                                                                  â”‚
â”‚  2. CalculateTotalFeeRate                                       â”‚
â”‚     â””â”€â”€ totalSwapFee = sum(feeRate[].FeeValue)                  â”‚
â”‚                                                                  â”‚
â”‚  3. mapRemarketerWebhookFilledDataToFilledSwap                  â”‚
â”‚     â””â”€â”€ à¸ªà¸£à¹‰à¸²à¸‡ FilledSwap à¸à¸£à¹‰à¸­à¸¡ SwapFee                          â”‚
â”‚                                                                  â”‚
â”‚  4. validateFilledSwap                                          â”‚
â”‚     â””â”€â”€ à¸•à¸£à¸§à¸ˆà¸ªà¸­à¸šà¸„à¸§à¸²à¸¡à¸–à¸¹à¸à¸•à¹‰à¸­à¸‡à¸‚à¸­à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥                         â”‚
â”‚                                                                  â”‚
â”‚  5. Marshal feeRateResult â†’ JSON                                â”‚
â”‚     â””â”€â”€ à¹€à¸•à¸£à¸µà¸¢à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ FeeDetail à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸à¹‡à¸šà¹ƒà¸™ DB               â”‚
â”‚                                                                  â”‚
â”‚  6. à¸ªà¸£à¹‰à¸²à¸‡ OrderTradeTransaction                                 â”‚
â”‚     â”œâ”€â”€ OrderFee â† filledSwap.OrderFee()                        â”‚
â”‚     â”œâ”€â”€ Vat â† filledSwap.Vat()                                  â”‚
â”‚     â”œâ”€â”€ OrderFeeRate â† totalSwapFee                             â”‚
â”‚     â”œâ”€â”€ FeeDetail â† JSON of feeRateResult                       â”‚
â”‚     â””â”€â”€ NetReceivedQuantity â† à¸„à¸³à¸™à¸§à¸“à¸ˆà¸²à¸ filledSwap                â”‚
â”‚                                                                  â”‚
â”‚  7. Insert into order_trade_transaction table                    â”‚
â”‚                                                                  â”‚
â”‚  8. getOrderTradeExchange                                       â”‚
â”‚     â””â”€â”€ à¸ªà¸£à¹‰à¸²à¸‡ OrderTradeExchange records                         â”‚
â”‚                                                                  â”‚
â”‚  9. Insert into order_trade_exchange table                       â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      calculateAndUpdateOrderTradeInformation (Line 996-1052)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. à¸”à¸¶à¸‡ OrderTradeTransaction à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸‚à¸­à¸‡ OrderTrade à¸™à¸µà¹‰          â”‚
â”‚  2. à¸”à¸¶à¸‡ OrderTradeExchange à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”                              â”‚
â”‚  3. Calculate Aggregates:                                        â”‚
â”‚     â”œâ”€â”€ SumOrderFee                                              â”‚
â”‚     â”œâ”€â”€ SumVat                                                   â”‚
â”‚     â”œâ”€â”€ SumNetReceivedQuantity                                   â”‚
â”‚     â”œâ”€â”€ AvgFeeRate                                               â”‚
â”‚     â””â”€â”€ à¸­à¸·à¹ˆà¸™à¹† ...                                               â”‚
â”‚  4. Update order_trade_information table                         â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            handleOnCompleteOrderTrade (Line 614-758)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  1. Update ActionFlow (FILLED â†’ SYNC_LEDGER)                     â”‚
â”‚  2. Update OrderTrade Status â†’ SYNC_LEDGER                       â”‚
â”‚  3. Create Ledger Transactions:                                  â”‚
â”‚     â”œâ”€â”€ Physical Ledger (Physical Ledger Transaction)            â”‚
â”‚     â”œâ”€â”€ Logical Ledger (Logical Ledger Transaction)              â”‚
â”‚     â””â”€â”€ Send to Ledger Service via Kafka                         â”‚
â”‚  4. Update ActionFlow (SYNC_LEDGER â†’ SYNCED)                     â”‚
â”‚  5. Update OrderTrade Status â†’ FILLED                            â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 11.2 à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”à¸à¸²à¸£à¸šà¸±à¸™à¸—à¸¶à¸ OrderTradeTransaction

**à¹„à¸Ÿà¸¥à¹Œ:** `pkg/order_trade/webhook_service.go` (à¸šà¸£à¸£à¸—à¸±à¸” 431-482)

### à¸Ÿà¸´à¸¥à¸”à¹Œà¸—à¸µà¹ˆà¹€à¸à¸µà¹ˆà¸¢à¸§à¸‚à¹‰à¸­à¸‡à¸à¸±à¸š Fee

| Field | Type | Source | Description |
|-------|------|--------|-------------|
| `order_fee` | decimal | `filledSwap.OrderFee()` | à¸„à¹ˆà¸²à¸˜à¸£à¸£à¸¡à¹€à¸™à¸µà¸¢à¸¡à¸—à¸µà¹ˆà¸„à¸³à¸™à¸§à¸“à¹„à¸”à¹‰ |
| `vat` | decimal | `filledSwap.Vat()` | à¸ à¸²à¸©à¸µà¸¡à¸¹à¸¥à¸„à¹ˆà¸²à¹€à¸à¸´à¹ˆà¸¡à¸—à¸µà¹ˆà¸„à¸³à¸™à¸§à¸“à¹„à¸”à¹‰ |
| `order_fee_rate` | decimal | `totalSwapFee` | Fee Rate à¸£à¸§à¸¡ (%) |
| `fee_detail` | JSON | `feeRateResult` | à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸” Fee à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¹à¸šà¸š JSON |
| `net_received_quantity` | decimal | `filledSwap.NetReceivedQuantity()` | à¸ˆà¸³à¸™à¸§à¸™à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸£à¸±à¸šà¸ªà¸¸à¸—à¸˜à¸´ |

### à¹‚à¸„à¸£à¸‡à¸ªà¸£à¹‰à¸²à¸‡ fee_detail (JSON)

```json
[
  {
    "transaction_type": "swap",
    "fee_type": "FEE",
    "name": "Tier 2 Fee",
    "fee_value": "0.10",
    "fee_unit": "percent",
    "is_include_additional_fee": false
  },
  {
    "transaction_type": "swap",
    "fee_type": "ADDITIONAL_FEE",
    "name": "Bitkub Route Fee",
    "fee_value": "0.02",
    "fee_unit": "percent",
    "is_include_additional_fee": false
  }
]
```

## 11.3 à¸à¸²à¸£à¸­à¸±à¸›à¹€à¸”à¸• OrderTradeInformation

**à¹„à¸Ÿà¸¥à¹Œ:** `pkg/order_trade/webhook_service.go` (à¸šà¸£à¸£à¸—à¸±à¸” 996-1052)

à¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸à¸šà¸±à¸™à¸—à¸¶à¸ OrderTradeTransaction à¹à¸¥à¹‰à¸§ à¸ˆà¸°à¸¡à¸µà¸à¸²à¸£à¸£à¸§à¸¡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”à¸‚à¸­à¸‡ OrderTrade à¹€à¸à¸·à¹ˆà¸­à¸­à¸±à¸›à¹€à¸”à¸• order_trade_information

### Aggregates à¸—à¸µà¹ˆà¸„à¸³à¸™à¸§à¸“

| Field | Formula | Description |
|-------|---------|-------------|
| `sum_order_fee` | `sum(tx.order_fee)` | à¸£à¸§à¸¡ OrderFee à¸—à¸¸à¸ Transaction |
| `sum_vat` | `sum(tx.vat)` | à¸£à¸§à¸¡ VAT à¸—à¸¸à¸ Transaction |
| `sum_net_received_quantity` | `sum(tx.net_received_quantity)` | à¸£à¸§à¸¡à¸ˆà¸³à¸™à¸§à¸™à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸£à¸±à¸šà¸ªà¸¸à¸—à¸˜à¸´ |
| `avg_fee_rate` | `sum_order_fee / total_fee_quantity` | à¸­à¸±à¸•à¸£à¸² Fee à¹€à¸‰à¸¥à¸µà¹ˆà¸¢ |

### à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸„à¸³à¸™à¸§à¸“ avg_fee_rate

```go
// à¸ˆà¸²à¸à¹„à¸Ÿà¸¥à¹Œ calculateOrderTradeTransactionAggregates (à¸šà¸£à¸£à¸—à¸±à¸” 1105-1221)
if orderSide == BUY {
    totalFeeQuantity = sumExecutedQuantity  // à¹ƒà¸Šà¹‰ executed quantity
} else if orderSide == SELL {
    totalFeeQuantity = sumReceivedQuantity  // à¹ƒà¸Šà¹‰ received quantity
}

if totalFeeQuantity > 0 {
    avgFeeRate = sumOrderFee.Div(totalFeeQuantity)
    avgFeeRate = RoundUp(avgFeeRate, 4)
}
```

## 11.4 à¸à¸²à¸£à¸ªà¹ˆà¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹„à¸› Ledger Service

à¸«à¸¥à¸±à¸‡à¸ˆà¸²à¸à¸­à¸±à¸›à¹€à¸”à¸• OrderTradeInformation à¹à¸¥à¹‰à¸§ à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸ˆà¸°à¸–à¸¹à¸à¸ªà¹ˆà¸‡à¹„à¸›à¸¢à¸±à¸‡ Ledger Service à¹€à¸à¸·à¹ˆà¸­à¸šà¸±à¸™à¸—à¸¶à¸à¸šà¸±à¸à¸Šà¸µ

### Flow à¸à¸²à¸£à¸ªà¸£à¹‰à¸²à¸‡ Ledger Transaction

**à¹„à¸Ÿà¸¥à¹Œ:** `pkg/order_trade/webhook_service.go` (à¸šà¸£à¸£à¸—à¸±à¸” 669-710)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  getCreatedLedgerTransactions                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  BUY Order:                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. stampPhysicalLedgerTransactionSwapBuyFilled           â”‚   â”‚
â”‚  â”‚    â””â”€â”€ Create Physical Ledger Transaction                â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ 2. stampExecutedLogicalLedgerTransactionSwapBuy          â”‚   â”‚
â”‚  â”‚    â””â”€â”€ Create Logical Ledger Transaction (Executed)      â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ 3. stampRefundedLogicalLedgerTransactionSwapBuy          â”‚   â”‚
â”‚  â”‚    â””â”€â”€ Create Logical Ledger Transaction (Refunded)      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚  SELL Order:                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ 1. stampPhysicalLedgerTransactionSwapSellFilled          â”‚   â”‚
â”‚  â”‚    â””â”€â”€ Create Physical Ledger Transaction                â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ 2. stampExecutedLogicalLedgerTransactionSwapSell         â”‚   â”‚
â”‚  â”‚    â””â”€â”€ Create Logical Ledger Transaction (Executed)      â”‚   â”‚
â”‚  â”‚                                                          â”‚   â”‚
â”‚  â”‚ 3. stampRefundedLogicalLedgerTransactionSwapSell         â”‚   â”‚
â”‚  â”‚    â””â”€â”€ Create Logical Ledger Transaction (Refunded)      â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                  â”‚
â”‚  4. produceCustomerTransactionLogical                            â”‚
â”‚     â””â”€â”€ Send to Kafka Topic (Customer Transaction Logical)      â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Ledger Service â”‚
                    â”‚  (Consumer)     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Balance in    â”‚
                    â”‚   Database      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸ªà¹ˆà¸‡à¹„à¸› Ledger Service

à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸ªà¹ˆà¸‡à¹„à¸›à¸›à¸£à¸°à¸à¸­à¸šà¸”à¹‰à¸§à¸¢:
- **OrderTrade** - à¸‚à¹‰à¸­à¸¡à¸¹à¸¥ Order
- **OrderTradeTransaction** - à¸£à¸§à¸¡ OrderFee, Vat
- **OrderTradeExchange** - à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸à¸²à¸£à¹à¸¥à¸à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™
- **LogicalLedgerTransaction** - à¸£à¸²à¸¢à¸à¸²à¸£à¸šà¸±à¸à¸Šà¸µà¸šà¸±à¸à¸Šà¸µ

## 11.5 à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸—à¸µà¹ˆà¸šà¸±à¸™à¸—à¸¶à¸à¹ƒà¸™ Database

### order_trade_transaction table

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id                           â”‚ order_fee     â”‚ vat      â”‚ fee_rate â”‚ fee_detail   â”‚ net_received_qty â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ tx-001                       â”‚ 12.00         â”‚ 0.78     â”‚ 0.12     | [...]        â”‚ 9987.22         â”‚
â”‚                              â”‚ THB           â”‚ THB      â”‚ %        â”‚              â”‚ THB             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ tx-002 (partial fill)        â”‚ 6.00          â”‚ 0.39     â”‚ 0.12     â”‚ [...]        â”‚ 4993.61         â”‚
â”‚                              â”‚ THB           â”‚ THB      â”‚ %        â”‚              â”‚ THB             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### order_trade_information table

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ id                           â”‚ sum_order_fee  â”‚ sum_vat  â”‚ avg_fee_rate      â”‚ sum_net_qty   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ info-001                     â”‚ 18.00 THB      â”‚ 1.17 THB â”‚ 0.0012            â”‚ 14980.83 THB  â”‚
â”‚                              â”‚                â”‚          â”‚ (0.12%)           â”‚               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## 11.6 à¸ªà¸£à¸¸à¸› Flow à¸«à¸¥à¸±à¸‡à¸„à¸³à¸™à¸§à¸“ OrderFee

```
Step 1: à¸„à¸³à¸™à¸§à¸“ OrderFee & VAT
   â†“
Step 2: à¹€à¸•à¸£à¸µà¸¢à¸¡ FeeDetail (JSON)
   â†“
Step 3: à¸šà¸±à¸™à¸—à¸¶à¸à¸¥à¸‡ order_trade_transaction
   â”œâ”€â”€ order_fee
   â”œâ”€â”€ vat
   â”œâ”€â”€ order_fee_rate
   â”œâ”€â”€ fee_detail (JSON)
   â””â”€â”€ net_received_quantity
   â†“
Step 4: à¸šà¸±à¸™à¸—à¸¶à¸ order_trade_exchange
   â†“
Step 5: à¸£à¸§à¸¡ Aggregates à¹à¸¥à¸°à¸­à¸±à¸›à¹€à¸”à¸• order_trade_information
   â”œâ”€â”€ sum_order_fee
   â”œâ”€â”€ sum_vat
   â”œâ”€â”€ avg_fee_rate
   â””â”€â”€ sum_net_received_quantity
   â†“
Step 6: à¸ªà¸£à¹‰à¸²à¸‡ Ledger Transactions
   â”œâ”€â”€ Physical Ledger
   â””â”€â”€ Logical Ledger (à¸ªà¹ˆà¸‡à¹„à¸› Ledger Service)
   â†“
Step 7: à¸­à¸±à¸›à¹€à¸”à¸• OrderTrade Status â†’ FILLED
```

---

# à¸ªà¸£à¸¸à¸›

| à¸«à¸±à¸§à¸‚à¹‰à¸­                 | à¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢                                          |
| ---------------------- | ------------------------------------------------- |
| **à¸—à¸µà¹ˆà¸¡à¸²à¸‚à¸­à¸‡ Fee Rate**  | Database Table `transaction_fee`                  |
| **à¸à¸²à¸£à¸„à¸³à¸™à¸§à¸“ Total Fee** | sum(all matched fee_value)                        |
| **OrderFee BUY**       | `executedQty Ã— (feeRate / 100)`                   |
| **OrderFee SELL**      | `(receivedQty + exchangeFee) Ã— (feeRate / 100)`   |
| **VAT**                | `orderFee Ã— 7 / 107`                              |
| **NetAmount BUY**      | `(amount - fee) / rate`                           |
| **NetAmount SELL**     | `matchedBookAmount - fee`                         |
| **à¸šà¸±à¸™à¸—à¸¶à¸ OrderFee**    | Table `order_trade_transaction.order_fee`         |
| **à¸šà¸±à¸™à¸—à¸¶à¸ VAT**         | Table `order_trade_transaction.vat`               |
| **à¸šà¸±à¸™à¸—à¸¶à¸ FeeDetail**   | Table `order_trade_transaction.fee_detail` (JSON) |
| **à¸£à¸§à¸¡ Fee à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”**    | Table `order_trade_information.sum_order_fee`     |
| **à¸ªà¹ˆà¸‡à¹„à¸› Ledger**       | Kafka Topic â†’ Ledger Service â†’ Balance            |
